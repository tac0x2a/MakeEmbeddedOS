# 12ステップで作る組み込みOS自作入門 のメモ．
## シリアル通信
* シリアル通信みたいなIFは信号線の周期の管理とか面倒なので，``コントローラ`` という専用チップが制御している．LANならLANコントローラ，とか．
* コントローラの制御はレジスタ経由で行う． [serial.c](/serial.c)  を参照．
* デバイスやチップごとに比較器が設けられており，アドレスバスの上位n本と，チップごとにユニークなnビットを比較して，一致した場合はそのチップを有効にする，みたいな感じでアドレス空間を分けている．このチップを有効にする信号を``CS(Chip Select)`` や ``CE(Chip Enable)`` と呼ぶ．このようにアドレスバスの一部を使ってチップを選択できることで，``メモリマップドIO``が実現されている．

## スタートアップ
* スタートアップとは，スタックポインタの設定してmain()へ飛ばすなど，プログラムの動作開始処理のこと．スタートアップを表す名前として， ``crt(C RunTime)`` ``locore`` とかが使われるらしい．
* 「割り込みハンドラを記述しておく特定のアドレス」のことを ``割り込みベクタ`` という．
* H8の場合は，割り込みベクタは 0x000000 - 0x0000ff に配置されている．
* H8は電源ON時にリセット割り込みが入り，ベクタテーブル先頭に配置されたリセット割り込みハンドラをコールする．そこにスタートアップのアドレスを登録しているので，電源投入時にスタートアップが動作するというわけ．


## 領域
### メモリ上の領域について
* ``テキスト領域`` - CPUが実行する機械語コード
* ``データ領域`` - 初期値を **持つ** 静的変数
* ``BSS領域`` - 初期値を **持たない** 静的変数
* 静的変数の配置先は，初期値の有無によって，データ領域かBSSに分けられる．後者は領域のサイズのみを持つため，実行形式ファイルのサイズを節約できる．

### 実行形式ファイル中の領域について
* 実行形式ファイルは内部で領域が分割されており，特定の領域単位でメモリ上へコピーされる．この領域のことを ``セクション`` という．
* 大抵の実行形式ファイルは，前述の3つのセクションを持っている．それぞれ， ``.text``, ``.data``, ``.bss`` に対応している．
* セクションの先頭に ``ヘッダ`` として，そのセクションの情報を保持している．
* この本では [ELF(Executable and Linkable Format)](http://ja.wikipedia.org/wiki/Executable_and_Linkable_Format)  を扱ってる．
* ``readelf`` コマンドで解析できるよ．
> %readelf -a <解析したい実行形式ファイル>

* ``.text`` セクションは H8/3069F の内蔵FlashROMがマッピングされているアドレスになっているため，CPUはROMから命令を読み込んで実行している
* ``.data`` や ``.bss`` が ROM上にマッピングされていると，変数を読めるけど変更できない！ みたいなことになる．


### リンカスクリプト
* プログラムのどの部分が，どのアドレスに配置されるかはリンクの時点で決まる．この指定を行うのが ``リンカスクリプト``． [ld.src](/ld.src)
* `` . `` は ``ロケーションカウンタ`` といい，カレントアドレスを示す． `` . = 0x0; `` は以降のセクションは0番地から配置するよ，という意味．

```
.vectors : {
    vector.o(.data)
}
```
これで， vector.o内のvectorsを.dataに置く，って意味になるのかな．
* Flashに書き込むべきデータの書き込み先アドレスが，RAM上になってると ``Address is out of range. Skipping..`` みたいなエラーが出る．